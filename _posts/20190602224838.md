---
ID: 4268
post_title: '[JavaScript] 不正なセレクタをエスケープする際の対処法'
published: true
post_date: 2019-06-02 22:48:38
modified_date: 2019-06-02 22:48:43
slug: 20190602224838.html
categories: |
  ---
  - !php/object "O:7:\"WP_Term\":16:{s:7:\"term_id\";i:384;s:4:\"name\";s:10:\"JavaScript\";s:4:\"slug\";s:10:\"javascript\";s:10:\"term_group\";i:0;s:16:\"term_taxonomy_id\";i:402;s:8:\"taxonomy\";s:8:\"category\";s:11:\"description\";s:0:\"\";s:6:\"parent\";i:0;s:5:\"count\";i:53;s:6:\"filter\";s:3:\"raw\";s:6:\"cat_ID\";i:384;s:14:\"category_count\";i:53;s:20:\"category_description\";s:0:\"\";s:8:\"cat_name\";s:10:\"JavaScript\";s:17:\"category_nicename\";s:10:\"javascript\";s:15:\"category_parent\";i:0;}"
  ...
tags: |
  ---
  - CSS
  - JavaScript
  ...
---
## セレクタとして不正な文字

まず数値から始まるセレクタは使用できない。
かつ、下記の文字列は先頭に限らず使用することは出来ない。

```
~ ! @ $ % ^ & * ( ) _ + - = , . / ' ; : " ? > < [ ] { } | ` #
```

これらの文字は制御コードに置き換える事でvalidなセレクタとして使用することも可能だが、簡単にバックスラッシュでエスケープすることもできる。

```html
<span id="~">text</span>
```

```css
#\~ { color: red; }
```

```js
document.querySelector('~'); 
```

## JavaScript上での取扱

対象のセレクタのinvalidな文字をエスケープすれば良い。
正規表現で置き換えていくのもアリだが、正規表現の妥当性をチェックするのが大変である。

### CSS.escape()

`CSS.escape()`を利用する。

```
CSS.escape(&quot;.foo#bar&quot;)        // &quot;\.foo\#bar&quot;
CSS.escape(&quot;()[]{}&quot;)          // &quot;\(\)\[\]\{\}&quot;
CSS.escape(&#039;--a&#039;)             // &quot;--a&quot;
CSS.escape(0)                 // &quot;\30 &quot;, the Unicode code point of &#039;0&#039; is 30
CSS.escape(&#039;\0&#039;)              // &quot;\ufffd&quot;, the Unicode REPLACEMENT CHARACTER
```
参考: [CSS.escape() - Web APIs | MDN](https://developer.mozilla.org/en-US/docs/Web/API/CSS/escape)

引数に`CSSOMString`を渡すと、エスケープ後のセレクタ文字列を返却してくれる。

---

ただし`CSS`メソッドは、IEなどのレガシーブラウザで使用できないので注意。
レガシーブラウザ対応が必要であれば、[polyfill](https://www.npmjs.com/package/css.escape)がオープンソースで提供されているので使うと良い。