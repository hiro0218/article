---
ID: 3360
title: '[Node.js] node-fetchでBASIC認証をしつつPUTする方法'
published: true
date: 2017-10-31 22:22:35
updated: 2017-10-31 22:22:35
slug: 20171031222235.html
categories:
  - JavaScript
tags: [ ]
---
## 概要
Node.jsを使って、BASIC認証をしつつファイルをPUTする必要に迫られた。

## 環境
- Node.js v8.4.0
- [node-fetch](https://www.npmjs.com/package/node-fetch) v1.7.3

## コード
```language-js
let uploadPath = "distribute/json/";
let filename = "test.json";
let readStream = fs.createReadStream("./hogehoge.json");

readStream.on("open", function() {
  fetch(uploadPath + filename, {
    method: "PUT",
    headers: {
      Authorization:
        "Basic " + new Buffer(`${userID}:${password}`).toString("base64")
    },
    body: readStream,
  })
  .then(function(res) {
    console.log("status: ", res.status);
    console.log("statusText: ", res.statusText);
  });
});
```

`fs.createReadStream`でストリームをopenし、fetchのbodyに渡す。BASIC認証については、Authorizationで下記のように指定する。

```language-js
"Basic " + new Buffer(`${userID}:${password}`).toString("base64")
```

`.catch()`でエラーを拾うことができるが、HTTP通信に関するエラーは`then(function(res){});`内で確認できる（404なども）。

また、`fs.createReadStream`のcloseは自動的にしてくれるようだ。

### 留意点
HTTP Status で `409` が返ってくる事があった。

> [409 Conflict - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Status/409)  
> HTTP 409 Conflict はリクエストが現在のサーバーの状態と競合したことを示すステータスコード。  
>    
> 競合は PUT メソッドを使用したリクエストのレスポンスで最も発生しやすい。例えば、サーバーにすでに存在しているファイルよりも古いバージョンのファイルをアップロードした際に409の応答が返され、バージョン管理システムの競合が発生する可能性がある。  

私の環境では、`uploadPath`として指定したディレクトリが存在しておらず、発生していた。（`distribute/json/`と指定していた場合、`json`のディレクトリが存在していなかった）