---
ID: 3360
post_title: '[Node.js] node-fetchでBASIC認証をしつつPUTする方法'
published: true
post_date: 2017-10-31 22:22:35
modified_date: 2017-10-31 22:22:35
slug: 20171031222235.html
categories: |
  ---
  - !php/object "O:7:\"WP_Term\":16:{s:7:\"term_id\";i:384;s:4:\"name\";s:10:\"JavaScript\";s:4:\"slug\";s:10:\"javascript\";s:10:\"term_group\";i:0;s:16:\"term_taxonomy_id\";i:402;s:8:\"taxonomy\";s:8:\"category\";s:11:\"description\";s:0:\"\";s:6:\"parent\";i:0;s:5:\"count\";i:53;s:6:\"filter\";s:3:\"raw\";s:6:\"cat_ID\";i:384;s:14:\"category_count\";i:53;s:20:\"category_description\";s:0:\"\";s:8:\"cat_name\";s:10:\"JavaScript\";s:17:\"category_nicename\";s:10:\"javascript\";s:15:\"category_parent\";i:0;}"
  ...
tags: |
  --- false
  ...
---
## 概要
Node.jsを使って、BASIC認証をしつつファイルをPUTする必要に迫られた。

## 環境
- Node.js v8.4.0
- [node-fetch](https://www.npmjs.com/package/node-fetch) v1.7.3

## コード
```language-js
let uploadPath = "distribute/json/";
let filename = "test.json";
let readStream = fs.createReadStream("./hogehoge.json");

readStream.on("open", function() {
  fetch(uploadPath + filename, {
    method: "PUT",
    headers: {
      Authorization:
        "Basic " + new Buffer(`${userID}:${password}`).toString("base64")
    },
    body: readStream,
  })
  .then(function(res) {
    console.log("status: ", res.status);
    console.log("statusText: ", res.statusText);
  });
});
```

`fs.createReadStream`でストリームをopenし、fetchのbodyに渡す。BASIC認証については、Authorizationで下記のように指定する。

```language-js
"Basic " + new Buffer(`${userID}:${password}`).toString("base64")
```

`.catch()`でエラーを拾うことができるが、HTTP通信に関するエラーは`then(function(res){});`内で確認できる（404なども）。

また、`fs.createReadStream`のcloseは自動的にしてくれるようだ。

### 留意点
HTTP Status で `409` が返ってくる事があった。

> [409 Conflict - HTTP | MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Status/409)  
> HTTP 409 Conflict はリクエストが現在のサーバーの状態と競合したことを示すステータスコード。  
>    
> 競合は PUT メソッドを使用したリクエストのレスポンスで最も発生しやすい。例えば、サーバーにすでに存在しているファイルよりも古いバージョンのファイルをアップロードした際に409の応答が返され、バージョン管理システムの競合が発生する可能性がある。  

私の環境では、`uploadPath`として指定したディレクトリが存在しておらず、発生していた。（`distribute/json/`と指定していた場合、`json`のディレクトリが存在していなかった）