---
ID: 3397
post_title: '[JavaScript] Cache Busting用に一定時間で更新されるクエリを作成する方法'
published: true
post_date: 2017-11-26 18:40:41
modified_date: 2017-11-26 18:40:41
slug: 20171126184041.html
categories: |
  ---
  - !php/object "O:7:\"WP_Term\":16:{s:7:\"term_id\";i:384;s:4:\"name\";s:10:\"JavaScript\";s:4:\"slug\";s:10:\"javascript\";s:10:\"term_group\";i:0;s:16:\"term_taxonomy_id\";i:402;s:8:\"taxonomy\";s:8:\"category\";s:11:\"description\";s:0:\"\";s:6:\"parent\";i:0;s:5:\"count\";i:53;s:6:\"filter\";s:3:\"raw\";s:6:\"cat_ID\";i:384;s:14:\"category_count\";i:53;s:20:\"category_description\";s:0:\"\";s:8:\"cat_name\";s:10:\"JavaScript\";s:17:\"category_nicename\";s:10:\"javascript\";s:15:\"category_parent\";i:0;}"
  ...
tags: |
  --- []
  ...
---
## Cache Bustingとは

下記のようにURLに意味のないクエリを付与して、キャッシュコントロール行うことを「Cache Busting」と呼ぶ。

```language-html
&lt;link href=&quot;style.css?20171221&quot; rel=&quot;stylesheet&quot;&gt;
&lt;script src=&quot;script.js?20171221&quot;&gt;&lt;/script&gt;
```

---

## 方法

HTML上でクエリを付与するのであれば、バックエンドの処理で付与したり、アセットパイプライン、タスクランナーなどで付与すれば良い。
ただ、JS内の処理だと何らかの方法でクエリを付与する必用がある。


### 必須ライブラリ

- [Moment.js | Home](https://momentjs.com/)

ライブラリを使用せずピュアなJSだけで実装は可能だが、日付を操作するのは大変なので今回は Moment.js を使用する。

### コード

```language-js
function createCacheBusting(thresholdMinutes) {
  var minutes = thresholdMinutes || 15;
  var start = moment();
  var remainder = minutes - start.minute() % minutes;

  return moment(start)
    .add("minutes", remainder)
    .format("YYYYMMDDHHmm");
}

//////

var cacheQuery = createCacheControl();

fetch(`${url}?${cacheQuery}`)
  .then(function(data) {
    // process data
  });
```

引数なしだと「`201712211715`」みたいな感じで15分毎にクエリが更新される。 
引数の`thresholdMinutes`に`30`や`60`を渡すことで30分毎・60分毎にクエリが更新されるようになる。