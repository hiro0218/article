---
ID: 1327
post_title: '[PHP] $_FILES[&#8216;hoge&#8217;]がundefinedになる問題'
published: true
post_date: 2014-07-08 23:26:26
modified_date: 2015-02-28 23:24:20
slug: 20140708232626.html
---
<p>はっきりとした理由は結局分かってはないんだけれど…。<br />
<!--more--></p>
<h2>状況</h2>
<p>1GBのファイルをアップロードできるアプリ。ファイルサイズが1GB以上の場合はエラーメッセージを返却する作り。<br />
しかし、1.2GBのファイルをアップロードしたときに $_FILES[&#8216;hoge&#8217;]が undefined になってしまった。</p>
<h2>仮説</h2>
<p>memory_limit, post_max_size, upload_max_filesize のいずれか、もしくは全ての設定値が1.2GBに対して足りないため、$_FILES[&#8216;hoge&#8217;] が作られないのではないか。(このとき、php.ini の設定は1GBのアップロードに最適化させていた)</p>
<h2>php.ini の設定</h2>
<p>1GBアップロードの想定はこんな感じで設定してた。</p>
<pre>memory_limit = 1230M
post_max_size = 1130M
upload_max_filesize = 1024M
</pre>
<p>2GBのアップロードに対応できる想定の値に変更。</p>
<pre>memory_limit = 2460M
post_max_size = 2260M
upload_max_filesize = 2048M</pre>
<h2>検証結果</h2>
<p>2GBまで対応させることで1.2GBのアップロードで問題が起きなくなった。<br />
1.2GBではなく2.2GBをアップロードすると同様の問題が発生するように想定できる。イタチごっこなので対応したい。</p>
<h2>対応</h2>
<p>「<a href="http://qiita.com/mpyw/items/939964377766a54d4682" target="_blank">PHP &#8211; ファイルアップロードの例外処理はこれぐらいしないと気が済まない &#8211; Qiita</a>」から丸パクリみたいな形になって恐縮だが、おおむね以下のような形で実装した。</p>
<ul>
<li>$_FILES[&#8216;upfile&#8217;] が存在するか確認</li>
<li>$_FILES[&#8216;upfile&#8217;][&#8216;error&#8217;] の内容を確認<br />
→ 致命的っぽいエラーは Exception を投げる</li>
<li>$_FILES[&#8216;upfile&#8217;][&#8216;size&#8217;] で定義した上限値との比較</li>
</ul>
<pre class="prettyprint linenums lang-php">try {
    if (
        !isset($_FILES['upfile']['error']) ||
        !is_int($_FILES['upfile']['error'])
    ) {
        throw new RuntimeException('パラメータが不正です');
    }

    switch ($_FILES['upfile']['error']) {
        case UPLOAD_ERR_OK: // OK
            break;
        case UPLOAD_ERR_NO_FILE:   // ファイル未選択
            throw new RuntimeException('ファイルが選択されていません');
        case UPLOAD_ERR_INI_SIZE:  // php.ini定義の最大サイズ超過
        case UPLOAD_ERR_FORM_SIZE: // フォーム定義の最大サイズ超過
            throw new RuntimeException('ファイルサイズが大きすぎます');
        default:
            throw new RuntimeException('その他のエラーが発生しました');
    }

    // ここで定義するサイズ上限のオーバーチェック
    if ($_FILES['upfile']['size'] > 1000000) {
        $message = 'ファイルサイズが大きすぎます。';
    }

} catch (Exception $e) {
    $message = $e->getMessage();
}
</pre>
<p>php.ini で設定した値の上限を超えた場合、つまり今回のように $_FILES[&#8216;hoge&#8217;] が見つからない場合は、以下の条件で拾う事ができるはず。</p>
<pre>!isset($_FILES['upfile']['error'])</pre>