---
ID: 4410
post_title: '[PHP] DOMDocumentでloadHTMLして文字化けする時の対処方法'
published: true
post_date: 2020-03-22 00:25:16
modified_date: 2020-03-22 00:25:16
slug: 20200322002507.html
categories: |
  ---
  - !php/object "O:7:\"WP_Term\":16:{s:7:\"term_id\";i:386;s:4:\"name\";s:3:\"PHP\";s:4:\"slug\";s:3:\"php\";s:10:\"term_group\";i:0;s:16:\"term_taxonomy_id\";i:404;s:8:\"taxonomy\";s:8:\"category\";s:11:\"description\";s:0:\"\";s:6:\"parent\";i:0;s:5:\"count\";i:23;s:6:\"filter\";s:3:\"raw\";s:6:\"cat_ID\";i:386;s:14:\"category_count\";i:23;s:20:\"category_description\";s:0:\"\";s:8:\"cat_name\";s:3:\"PHP\";s:17:\"category_nicename\";s:3:\"php\";s:15:\"category_parent\";i:0;}"
  ...
tags: |
  ---
  - !php/object "O:7:\"WP_Term\":10:{s:7:\"term_id\";i:551;s:4:\"name\";s:3:\"PHP\";s:4:\"slug\";s:3:\"php\";s:10:\"term_group\";i:0;s:16:\"term_taxonomy_id\";i:559;s:8:\"taxonomy\";s:8:\"post_tag\";s:11:\"description\";s:0:\"\";s:6:\"parent\";i:0;s:5:\"count\";i:1;s:6:\"filter\";s:3:\"raw\";}"
  ...
---
## 状況

下記のコードを実行した際にマルチバイト文字が文字化けする。

```php
// h2 要素のみ取り出し
$content = &#039;&lt;h2&gt;見出し&lt;/h2&gt;&lt;p&gt;文章&lt;/p&gt;&#039;;
$headings = [];
$dom = new DOMDocument();
$dom-&gt;loadHTML($content);
$nodes = $dom-&gt;getElementsByTagName(&#039;h2&#039;);

foreach ($nodes as $node) {
  $headings[] = $node-&gt;textContent;
}
```

`見出し` -> `è¦åºã` となってしまう。


## 方法

```php
// h2 要素のみ取り出し
$content = &#039;&lt;h2&gt;見出し&lt;/h2&gt;&lt;p&gt;文章&lt;/p&gt;&#039;;
$headings = [];
$dom = new DOMDocument();
$dom-&gt;loadHTML(mb_convert_encoding($content, &#039;HTML-ENTITIES&#039;, &#039;UTF-8&#039;));
$nodes = $dom-&gt;getElementsByTagName(&#039;h2&#039;);

foreach ($nodes as $node) {
  $headings[] = $node-&gt;textContent;
}
```

`DOMDocument::loadHTML`は、文字列を`ISO-8859-1`として扱うためUTF-8文字が化けてしまっている。
なので、`mb_convert_encoding`でUTF-8へ変換して`$dom->loadHTML`へ文字列を渡すようにする。

下記のような`DOCTYPE`の宣言が含まれている文字列だとUTF-8として解釈してくれる。

```php
$dom-&gt;loadHTML(&#039;&lt;?xml encoding=&quot;utf-8&quot; ?&gt;&#039; . $content);
```