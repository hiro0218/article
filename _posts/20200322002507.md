---
ID: 4410
post_title: '[PHP] DOMDocumentでloadHTMLして文字化けする時の対処方法'
author: hiro
post_excerpt: ""
layout: post
permalink: https://b.0218.jp/20200322002516.html
published: true
post_date: 2020-03-22 00:25:16
slug: ""
---
## 状況

下記のコードを実行した際にマルチバイト文字が文字化けする。

```php
// h2 要素のみ取り出し
$content = &#039;&lt;h2&gt;見出し&lt;/h2&gt;&lt;p&gt;文章&lt;/p&gt;&#039;;
$headings = [];
$dom = new DOMDocument();
$dom-&gt;loadHTML($content);
$nodes = $dom-&gt;getElementsByTagName(&#039;h2&#039;);

foreach ($nodes as $node) {
  $headings[] = $node-&gt;textContent;
}
```

`見出し` -> `è¦åºã` となってしまう。


## 方法

```php
// h2 要素のみ取り出し
$content = &#039;&lt;h2&gt;見出し&lt;/h2&gt;&lt;p&gt;文章&lt;/p&gt;&#039;;
$headings = [];
$dom = new DOMDocument();
$dom-&gt;loadHTML(mb_convert_encoding($content, &#039;HTML-ENTITIES&#039;, &#039;UTF-8&#039;));
$nodes = $dom-&gt;getElementsByTagName(&#039;h2&#039;);

foreach ($nodes as $node) {
  $headings[] = $node-&gt;textContent;
}
```

`DOMDocument::loadHTML`は、文字列を`ISO-8859-1`として扱うためUTF-8文字が化けてしまっている。
なので、`mb_convert_encoding`でUTF-8へ変換して`$dom->loadHTML`へ文字列を渡すようにする。

下記のような`DOCTYPE`の宣言が含まれている文字列だとUTF-8として解釈してくれる。

```php
$dom-&gt;loadHTML(&#039;&lt;?xml encoding=&quot;utf-8&quot; ?&gt;&#039; . $content);
```