---
ID: 4125
post_title: >
  IE11などレガシィブラウザを意識したWebP画像の表示方法
published: true
post_date: 2019-02-13 17:57:35
modified_date: 2019-03-11 10:53:50
slug: 20190213175735.html
categories: |
  - HTML
tags: |
  - WebP
---
## WebPとは

> WebP（ウェッピー）は、米Googleが開発しているオープンな静止画フォーマット。ファイルの拡張子は「.webp」。
> 
> ウェブサイトのトラフィック量軽減と表示速度短縮を目的としており、インターネットのWebページで広く使われている非可逆圧縮のJPEGや可逆圧縮のGIF、PNGの置き換えを意図する規格である。JPEGとは異なり、非可逆圧縮でもアルファチャンネルを扱える。
> [https://ja.wikipedia.org/wiki/WebP](https://ja.wikipedia.org/wiki/WebP)

これらの特徴のほか、

- WebP lossy support
- WebP lossy, lossless & alpha support
- WebP Animation support

> Googleの示した事例では、ファイルサイズは非可逆圧縮モードで（同一画像、同等画質の）JPEGと比較して25-34%小さくなり、可逆圧縮モードでPNGと比較して28%小さくなるとしている。また22%のファイルサイズ増加でアルファチャネルを追加できるとしている。

圧縮率は従来のフォーマットよりも優れており、WebPを導入でページのロードタイムが30%改善されたという事例もある。

また、Googleが推し進めているためか、Lighthouseでは「[次世代フォーマットで画像を配信](https://developers.google.com/web/tools/lighthouse/audits/webp)」といったWebPの利用を進めるレポート結果が出る場合もある。

### WebP変換方法

[cwebp](https://developers.google.com/speed/webp/docs/cwebp)を使ってみる。

```
brew install webp
```

でインストールして、

```
cwebp -q 80 hoge.png -o hoge.webp
```

みたいな形で変換を行う。簡単。

## 実装方法

WebPは、すべてのブラウザで対応されているわけではない。今現在、全体の72%が対応している状況である。（[サポート状況](https://caniuse.com/#feat=webp)）

既存のフロントエンド実装をそのまま活かしたい、もしくは未対応ブラウザでのフォールバック対応を行いたくない場合は、Acceptリクエストヘッダーを利用して、サーバ側で適切な画像フォーマットをクライアントへ配信する仕組みもつくる事ができるだろう。
しかしながら本記事では、HTML5の`<picture>`要素を使ったフロントエンドでの実装方法について記載する。


### `<picture>`要素を使う

`<picture>`要素を利用することで対応していないブラウザへのフォールバックが簡単に行える。

```language-html
&lt;picture&gt;
  &lt;source srcset=&quot;https://www.gstatic.com/webp/gallery/1.webp&quot; type=&quot;image/webp&quot;&gt;
  &lt;source srcset=&quot;https://www.gstatic.com/webp/gallery/1.jpg&quot; type=&quot;image/jpeg&quot;&gt; 
  &lt;img src=&quot;https://www.gstatic.com/webp/gallery/1.jpg&quot;&gt;
&lt;/picture&gt;
```

### `<picture>`要素の非対応ブラウザへの対応

ほとんどのブラウザは対応しているが、[IE11が対応していない](https://caniuse.com/#feat=picture)ため、polyfillを使用する必要がある。
polyfillで[ググる](https://www.google.com/search?q=picture+polyfill)と色々と出てくるのだが、`polyfill.io`を利用していきたいと思う。

```html
&lt;script crossorigin=&quot;anonymous&quot; src=&quot;https://polyfill.io/v3/polyfill.min.js?features=default%2CHTMLPictureElement&quot;&gt;&lt;/script&gt;
```

`polyfill.io`経由でpolyfillを取得することで、対応ブラウザへの無駄なpolyfillを配信せずに済む。


## デモ

<iframe height="400" style="width: 100%;" scrolling="no" title="Cases using WebP images" src="//codepen.io/hiro0218/embed/RvyELw/?height=265&theme-id=light&default-tab=result" frameborder="no" allowtransparency="true" allowfullscreen="true">
  See the Pen <a href='https://codepen.io/hiro0218/pen/RvyELw/'>Cases using WebP images</a> by hiro
  (<a href='https://codepen.io/hiro0218'>@hiro0218</a>) on <a href='https://codepen.io'>CodePen</a>.
</iframe>

## おわり

WebPは画像サイズを大幅に削減だけではなく、フォーマットが統一されることでの管理コストも下げられるのではないかと思う。ただ、実際はブラウザのサポート状況を考慮する結果、フォーマットが統一されるどころか重複した管理になってしまう点は否めない。
非サポートブラウザの影響のない環境下であれば（たとえばモバイルサイト）、低コストで大幅なフロントエンドの改善が見込まれるのではないだろうか。