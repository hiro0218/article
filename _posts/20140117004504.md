---
ID: 1121
post_title: '[PHP] cURLのPOSTでファイルアップロードする方法'
published: true
post_date: 2014-01-17 00:45:04
modified_date: 2015-02-28 23:24:27
slug: 20140117004504.html
categories: |
  ---
  - !php/object "O:7:\"WP_Term\":16:{s:7:\"term_id\";i:386;s:4:\"name\";s:3:\"PHP\";s:4:\"slug\";s:3:\"php\";s:10:\"term_group\";i:0;s:16:\"term_taxonomy_id\";i:404;s:8:\"taxonomy\";s:8:\"category\";s:11:\"description\";s:0:\"\";s:6:\"parent\";i:0;s:5:\"count\";i:23;s:6:\"filter\";s:3:\"raw\";s:6:\"cat_ID\";i:386;s:14:\"category_count\";i:23;s:20:\"category_description\";s:0:\"\";s:8:\"cat_name\";s:3:\"PHP\";s:17:\"category_nicename\";s:3:\"php\";s:15:\"category_parent\";i:0;}"
  ...
tags: |
  --- false
  ...
---
cURLでのファイルアップロード方法が分からず試行錯誤してました。

色々と調べて`$f = fopen($_FILES[$file_data]['tmp_name'], 'r');`を`curl_setopt($conn, CURLOPT_INFILE, $f);`で指定してみたりもしましたが上手くいきませんでした…。
<span class="text-muted">もしかしたら別の環境では上手くいくのかしら…?</span>

最終的に上手く動いてくれた方法の覚書です。

<!--more-->

## 方法

```language-php
&lt;?php
// API
$url = &#039;http://api-server/&#039;;

$tmpfile  = $_FILES[$file_data][&#039;tmp_name&#039;];
$filename = $_FILES[$file_data][&#039;name&#039;];

$data = array(
    &#039;filedata_param&#039; =&gt; &#039;@&#039; . $tmpfile . &#039;;filename=&#039; . $filename
);

$conn = curl_init();

curl_setopt($conn, CURLOPT_SSL_VERIFYPEER, false);
curl_setopt($conn, CURLOPT_SSL_VERIFYHOST, false);
curl_setopt($conn, CURLOPT_RETURNTRANSFER, true);
curl_setopt($conn, CURLOPT_URL, $url);
curl_setopt($conn, CURLOPT_POST, true);
curl_setopt($conn, CURLOPT_POSTFIELDS, $data);

$res = curl_exec($conn);

curl_close($conn); 
```

そもそもcURLでアップロードするファイルを指定する時は`file=@file.zip;type=application/x-zip-compressed`な感じで指定してやる必要があるわけで。
それと同じようにPHPでも指定してやると上記のようになります。